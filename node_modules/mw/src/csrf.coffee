hat = require 'hat'
defaultError = (req, res) ->
    console.error 'csrf error', 'expected', req.session.csrfToken, 'actual', req?.body?.csrf_token
    res.end 'an error occurred...'

module.exports = (onFail = defaultError) -> (req, res, next) ->
    throw new Error 'missing session' unless req.session?
    req.session.csrfToken ?= hat 64*4
    return next() if req.method.toUpperCase() in ['GET', 'HEAD']
    return next() if req?.body?.csrf_token is req.session.csrfToken
    # we have a problem
    delete req.session.csrfToken
    onFail req, res
